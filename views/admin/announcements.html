<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Объявления — Админ-панель</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/admin.css">
</head>

<body>
    <nav class="navbar">
        <div class="navbar-container container">
            <a href="/" class="logo">21-<span>IDUM</span></a>
            <ul class="nav-links">
                <li><a href="/">На сайт</a></li>
            </ul>
        </div>
    </nav>

    <section class="admin-wrap">
        <div class="container">
            <div class="admin-shell">
                <aside class="admin-sidebar">
                    <div class="topbar">
                        <strong id="userLabel">Админ</strong>
                        <button id="logoutBtn" class="btn btn-sm btn-danger">Выйти</button>
                    </div>
                    <ul class="nav-list" id="navMenuAdmin">
                        <li><a href="/admin">Дашборд</a></li>
                        <li><a href="/admin/news">Новости</a></li>
                        <li><a href="/admin/announcements" class="active">Объявления</a></li>
                        <li><a href="/admin/faq">FAQ</a></li>
                        <li><a href="/admin/events">События</a></li>
                        <li><a href="/admin/gallery">Галерея</a></li>
                        <li><a href="/admin/teachers">Учителя</a></li>
                        <li><a href="/admin/reviews">Отзывы</a></li>
                        <li id="scheduleMenuAdmin"><a href="/admin/schedule">Расписание</a></li>
                        <li id="usersMenuAdmin"><a href="/admin/users">Пользователи</a></li>
                        <li id="auditMenuAdmin"><a href="/admin/audit">Последние входы</a></li>
                    </ul>
                </aside>
                <main class="admin-content">
                    <div class="topbar">
                        <div>
                            <h1 style="margin:0 0 4px; font-size:22px">Объявления</h1>
                            <p class="muted" style="margin:0">Управление важными объявлениями сайта</p>
                        </div>
                        <a href="/admin/announcements/create" class="btn">+ Создать</a>
                    </div>

                    <div id="announcementsTable">
                        <div class="empty">Загрузка...</div>
                    </div>
                </main>
            </div>
        </div>
    </section>

    <script src="/admin-nav.js"></script>
    <script>
        // Load announcements list
        async function loadAnnouncements() {
            try {
                const res = await fetch('/api/announcements');
                if (!res.ok) throw new Error('Failed to fetch');

                const data = await res.json();
                const container = document.getElementById('announcementsTable');

                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="empty">Нет объявлений. Создайте первое!</div>';
                    return;
                }

                const typeLabels = {
                    info: 'Информация',
                    event: 'Мероприятие',
                    important: 'Важно',
                    urgent: 'Срочно',
                    competition: 'Конкурс',
                    achievement: 'Достижение'
                };

                container.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Заголовок</th>
                                <th>Тип</th>
                                <th>Дата</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(item => `
                                <tr>
                                    <td><strong>${item.title}</strong></td>
                                    <td><span class="badge badge-${item.type}">${typeLabels[item.type] || item.type}</span></td>
                                    <td>${new Date(item.date).toLocaleDateString('ru-RU')}</td>
                                    <td>
                                        <a href="/admin/announcements/edit/${item.id}" class="btn btn-sm">Редактировать</a>
                                        <button class="btn btn-sm btn-danger" onclick="deleteAnnouncement('${item.id}')">Удалить</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                document.getElementById('announcementsTable').innerHTML =
                    '<div class="empty error">Ошибка загрузки объявлений</div>';
            }
        }

        async function deleteAnnouncement(id) {
            if (!confirm('Удалить это объявление?')) return;

            try {
                const res = await fetch(`/api/admin/announcements/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                });

                if (!res.ok) throw new Error('Failed to delete');

                alert('Объявление удалено');
                loadAnnouncements();
            } catch (err) {
                alert('Ошибка при удалении');
            }
        }

        document.addEventListener('DOMContentLoaded', loadAnnouncements);
    </script>
    <script src="/csrf-helper.js"></script>
</body>

</html>
